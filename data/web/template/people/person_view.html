{% extends "layout.html" %}
{% set navigation=['people'] %}
{% set scripts = ['hedwig_util', 'unmangle', 'person_groups'] %}
{% if is_current_user %}
    {% set help_link=url_for('help.user_page', page_name='profile') %}
{% endif %}

{% block content %}

{% if show_admin_links and person.admin %}
    <p class="minor_warning">
        <span class="fa-solid fa-user-shield"></span>
        Site administrator.
    </p>
{% endif %}
{% if person.user_id is none %}
    <p class="minor_warning">
        <span class="fa-solid fa-user-slash"></span>
        This profile does not belong to a registered user.
    </p>
{% elif show_admin_links and not person.verified %}
    <p class="warning">
        <span class="fa-solid fa-user-lock"></span>
        This profile has not been verified.
    </p>
{% endif %}
{% if is_current_user %}
    <nav>
        <ol id="account_manage_links" class="fa-ul">
            <li><a href="{{ url_for('.change_password') }}"><span class="fa-li"><span class="fa-solid fa-key"></span></span>Change password</a></li>
            <li><a href="{{ url_for('.change_user_name') }}"><span class="fa-li"><span class="fa-solid fa-user-gear"></span></span>Change user name</a></li>
        </ol>
        <ol class="fa-ul">
            <li><a href="{{ url_for('.person_proposals') }}"><span class="fa-li"><span class="fa-solid fa-book"></span></span>Your proposal list</a></li>
            <li><a href="{{ url_for('.person_reviews') }}"><span class="fa-li"><span class="fa-solid fa-file-lines"></span></span>Your review list</a></li>
        </ol>
    </nav>
{% endif %}
{% if show_viewer_links and not is_current_user %}
    <nav>
        <ol id="account_viewer_links" class="fa-ul">
            <li><a href="{{ url_for('.person_view_proposals', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-book"></span></span>View proposal list</a></li>
            <li><a href="{{ url_for('.person_view_reviews', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-file-lines"></span></span>View review list</a></li>
        </ol>
    </nav>
{% endif %}
{% if show_admin_links %}
    <nav>
        <ol id="account_admin_links" class="fa-ul">
            <li><a href="{{ url_for('admin.message_list', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-envelope"></span></span>View messages</a></li>
            {% if person.user_id is none %}
                <li><a href="{{ url_for('.person_invite', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-comment-medical"></span></span>Invite to register</a></li>
            {% else %}
                <li><a href="{{ url_for('.user_log', user_id=person.user_id) }}"><span class="fa-li"><span class="fa-solid fa-user-tag"></span></span>User account log</a></li>
                <li><a href="{{ url_for('.person_log', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-user-tag"></span></span>Person action log</a></li>
                <li><a href="{{ url_for('.person_subsume', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-object-group"></span></span>Subsume duplicate profile</a></li>
            {% endif %}
        </ol>
    </nav>
{% endif %}

<table>
    <tr>
        <th>Full name</th>
        <td>
            {% if person.title is not none %}{{ person.title | title_name }}{% endif %}
            {{ person.name }}
        </td>
    </tr>
    {% if is_current_user or show_admin_links %}
        <tr>
            <th>User directory</th>
            <td>{{ 'Shown' if person.public else 'Not shown' }} in directory</td>
        </tr>
    {% endif %}
    {% if person.institution is not none %}
        <tr>
            <th>Institution</th>
            <td>
                <a href="{{ url_for('.institution_view', institution_id=person.institution.id) }}">{{ person.institution.name }}</a>
                <br />
                {% if person.institution.department %}
                    {{ person.institution.department }}
                    <br />
                {% elif person.institution.department_abbr is not none %}
                    {{ person.institution.department_abbr }}
                    <br />
                {% endif %}
                {% if person.institution.organization %}
                    {{ person.institution.organization }}
                    <br />
                {% elif person.institution.organization_abbr is not none %}
                    {{ person.institution.organization_abbr }}
                    <br />
                {% endif %}
                {{ person.institution.country | country_name }}
            </td>
        </tr>
    {% endif %}
    {% if person.email is not none %}
        {% for email in person.email %}
            <tr>
                {% if loop.first %}
                    <th rowspan="{{ person.email | length }}">Email</th>
                {% endif %}
                <td>
                    <span class="mangled_address" data-mangled="{{ email.address | mangle_email_address }}">&nbsp;</span>
                    {% if email.primary %}<span class="label">primary</span>{% endif %}
                    {% if email.public %}<span class="label">public</span>{% endif %}
                    {% if email.verified %}
                        <span class="label">verified</span>
                    {% elif is_current_user %}
                        <a href="{{ url_for('.person_email_verify_get', person_id=person.id, email_id=email.id) }}" id="email_{{ email.id }}_verify_link"><span class="fa-solid fa-envelope-circle-check"></span>Verify</a>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    {% endif %}
</table>

{% if can_edit %}
    <nav>
        <ol id="profile_manage_links" class="fa-ul">
            <li><a href="{{ url_for('.person_edit', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-user-pen"></span></span>Edit profile</a></li>
            <li><a href="{{ url_for('.person_edit_email', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-address-card"></span></span>Edit email addresses</a></li>
            <li><a href="{{ url_for('.person_edit_institution', person_id=person.id) }}"><span class="fa-li"><span class="fa-solid fa-building-columns"></span></span>Change institution</a></li>
        </ol>
    </nav>
{% endif %}

{% if site_group_membership %}
    <h2>Site Groups</h2>

    <table>
        <tr>
            <th>Group</th>
            <th>Member?</th>
        </tr>
        {% for (site_group_type, site_group_name) in site_groups.items() %}
            <tr>
                <td><a href="{{ url_for('admin.site_group_view', site_group_type=site_group_type) }}">{{ site_group_name }}</a></td>
                <td class="text_center">{% if site_group_membership.has_entry(site_group_type=site_group_type) %}&check;{% else %}&nbsp;{% endif %}</td>
            </tr>
        {% endfor %}
    </table>
{% endif %}

{% if review_group_membership %}
    <h2>Review Groups</h2>

    {% for facility in review_group_membership %}
        <h3>{{ facility.name }}</h3>

        <table class="review_group_membership">
            <thead>
                <tr>
                    <th class="sortable sortedalready" data-sortkey="queue_name">Queue</th>
                    {% for (group_type, group_name) in facility.review_groups.items() %}
                        <th class="sortable sortreverse" data-sortkey="group_{{group_type}}">{{ group_name }}</th>
                    {% endfor %}
                    <th>Links</th>
                </tr>
            </thead>
            <tbody>
                {% for (group_type, queue_groups) in facility.groups.sorted().group_by('queue_id') %}
                    {% with group = queue_groups | first_value %}
                        <tr data-sortinfo="{{ {'queue_name': group.queue_name} | json(dynamic=[('group', facility.review_groups.keys(), false, (queue_groups, 'has_entry', 'group_type', none), none)]) }}">
                            <td><a href="{{ url_for(facility.code + '.queue_view', queue_id=group.queue_id) }}">{{ group.queue_name }}</a></td>

                            {% for group_type in facility.review_groups.keys() %}
                                <td class="text_center">{% if queue_groups.has_entry(group_type=group_type) %}&check;{% else %}&nbsp;{% endif %}</td>
                            {% endfor %}
                            <td><a href="{{ url_for(facility.code + '.group_view_all', queue_id=group.queue_id) }}"><span class="fa-solid fa-users"></span>View</a></td>
                        </tr>
                    {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
{% endif %}
{% endblock %}
